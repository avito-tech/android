---
date: 2019-12-26
title: Open source для CI/CD и тестовой инфраструктуры Авито для Android
tags: [open-source]
---

# Open source для CI/CD и тестовой инфраструктуры Авито для Android

Мы вынесли в&nbsp;open source инфраструктуру Авито для&nbsp;Android: Gradle плагины, эмуляторы и библиотеки для&nbsp;тестов. 
[Наш код](https://github.com/avito-tech/avito-android) будет полезен при&nbsp;автоматизации CI/CD, а также облегчит написание и поддержку автотестов.
 
В&nbsp;этой обзорной статье мы расскажем, почему решили сделать свою работу открытой, о&nbsp;наиболее значимых библиотеках проекта и сориентируем, куда идти с&nbsp;возникающими вопросами. 
Детально разберём отдельные библиотеки, Gradle-плагины и наши подходы к разработке в&nbsp;следующих материалах. 

![](https://habrastorage.org/webt/ij/ha/sr/ijhasr2dv95azaem9mgilu7e1kw.png)

## Кто мы такие и чем занимаемся

Мы работаем на&nbsp;Android-направлении в&nbsp;платформенной команде Speed. Нас четыре человека: 

{{< columns >}}

Серёжа Боиштян\
Senior engineer\
[Твиттер-аккаунт](https://twitter.com/sboishtyan)

![](https://user-images.githubusercontent.com/1104540/80411459-e8e53080-88d4-11ea-9751-1ed675da9f25.jpg)

<--->

Дима Воронин\
Lead engineer\
[Твиттер-аккаунт](https://twitter.com/DmitriVoronin)

![](https://user-images.githubusercontent.com/1104540/80411540-074b2c00-88d5-11ea-8087-ddbab5d85dd3.jpg)

<--->

Женя Кривобоков\
Senior engineer\
[Твиттер-аккаунт](https://twitter.com/eugene_kr)

![](https://user-images.githubusercontent.com/1104540/80413105-9a856100-88d7-11ea-9e07-b5a5e48882cf.png)

<--->

Даниил Попов\
Senior engineer\
[Твиттер-аккаунт](https://twitter.com/int02h)

![](https://user-images.githubusercontent.com/1104540/80411864-8d677280-88d5-11ea-8a91-4f40d3eec71d.jpg)

{{< /columns >}}

Мы отвечаем за&nbsp;то, чтобы быстрее доставлять изменения во&nbsp;всех Android-приложениях Авито до&nbsp;пользователей. 
В&nbsp;нашу зону ответственности входят: 

- Локальная работа с&nbsp;проектом: чтобы всё быстро собиралось и IDE не тормозила.
- CI pipeline: тесты, все возможные проверки.
- CD: инструменты для&nbsp;релиз-инженеров.

## Зачем нам нужен open source

Мы хотели не просто отзеркалить код в&nbsp;открытом репозитории на&nbsp;Гитхабе, а сделать это с пользой для&nbsp;себя и инженерного сообщества. 
Основных причин вынести проект в&nbsp;open source — пять:

- Получить обратную связь.
- Влиять на&nbsp;стандарты в&nbsp;индустрии.
- Научиться новому.
- Влиять на&nbsp;сторонние библиотеки.
- Прокачать личный бренд.

Давайте коротко по&nbsp;ним пройдёмся. 

### Получить обратную связь и сделать код проще для&nbsp;повторного использования

Мы делаем тулинг для&nbsp;инженеров Авито, и нашим пользователям нужно, чтобы все решения просто работали. 
Нам не хватает взгляда со&nbsp;стороны от&nbsp;разработчиков, которые решают похожие задачи. 
Будет круто, если нам укажут на&nbsp;проблемы во&nbsp;внутренней реализации и удобстве подключения к&nbsp;нашему проекту.

Мы уже увидели, как перенос кода в&nbsp;Гитхаб подсветил проблемы переиспользования. Когда понимаешь, что этим могут пользоваться другие компании, то по-другому смотришь на&nbsp;архитектуру. 
Переиспользование кода — не самоцель. Но этот внешний критерий многое говорит о&nbsp;качестве архитектуры и её гибкости.

### Влиять на стандарты в&nbsp;индустрии

Мы развиваем инфраструктуру для&nbsp;мобильных приложений c&nbsp;2017&nbsp;года и регулярно рассказываем об&nbsp;этом на&nbsp;конференциях и митапах:

- [Дмитрий Воронин «Android инфраструктура Авито в Open Source»](https://youtu.be/fnkIK3pcH74) - Android Broadcast.
- [Сергей Боиштян «CI/CD здорового человека»](https://www.youtube.com/watch?v=AiizJd39G3Q) - AppsConf 2019.
- [Алексей Шпирко «Автотесты в&nbsp;Авито. Зачем они, как помогают, сколько стоят»](https://youtu.be/25EO8E3DMPw) — Apps Conf Moscow 2019.
- [Евгений Кривобоков «Ускорение сборки многомодульного Android-приложения»](https://youtu.be/MGczcEukjEY) — Apps Conf Moscow 2019.
- [Алексей Шпирко «Релизы мобильных приложений в&nbsp;Авито»](https://youtu.be/r3rUedCbe7Q) — Mobius 2018 Piter.
- [Дмитрий Меркурьев "Impact Analysis"](https://youtu.be/EBO2S9qcp0s?t=6948) — AppsConf: QualityApps 2018.
- [Николай Нестеров «Эволюция CI в&nbsp;команде мобильной разработки»](https://youtu.be/lz8MNATTUCU) — Saint AppsConf 2018.

Помимо рассказов, мы всегда хотели поделиться кодом и дать возможность его переиспользовать. 
Ведь многие Android-разработчики сталкиваются с&nbsp;похожими вызовами:

- Как писать автотесты, чтобы они приносили пользу.
- Как запускать их в&nbsp;pull request’ах.
- Как дешевле поддерживать инфраструктуру.

Для&nbsp;этих задач нет общепринятых и устоявшихся решений&nbsp;— каждая компания действует по-своему. 
Мы делимся своими наработками, чтобы в&nbsp;новых проектах разработчикам не приходилось собирать по&nbsp;крупицам информацию о&nbsp;тестировании мобильных приложений и построении CI/CD. 
Хочется, чтобы вместо написания своего велосипеда можно было взять готовые решения для&nbsp;рутинных проблем. 
И, даже если кодом проекта в&nbsp;исходном виде никто не воспользуется, разработчики смогут подсмотреть наши подходы и улучшить собственные библиотеки. 

### Научиться, объясняя другим

Просто вынести код в&nbsp;open source — недостаточно. Важны практики, подходы, пути поиска проблем и принятия решений. 
Показывая их, мы проверяем, насколько наши идеи и готовые предложения работают вне Авито.

### Влиять на&nbsp;сторонние библиотеки и быстрее исправлять их проблемы

Представьте, что вы столкнулись с&nbsp;проблемой в&nbsp;Android или библиотеке и не можете найти обходной путь. 
Вам нужна помощь сообщества или авторов кода. Вы задали вопрос на&nbsp;Stack Overflow, создали баг в&nbsp;Google IssueTracker, 
всё подробно описали, но проблема не воспроизводится. У&nbsp;вас просят тестовый пример. На всё это уходит дополнительное время.

Open source помогает быстрее создать воспроизводимый пример. 
У&nbsp;нас есть [тестовое приложение](https://github.com/avito-tech/avito-android/tree/develop/subprojects/android-test/test-app), в&nbsp;котором используется часть инфраструктуры. 
Главная его задача — dogfooding, то есть как можно раньше проверить на&nbsp;простом и изолированном примере, что всё работает. 
Но это же приложение позволяет проще показывать баги. Когда мы даём воспроизводимый пример в&nbsp;чужой библиотеке, её автору проще понять, в&nbsp;чём дело. 
Это повышает шансы, что он возьмётся за&nbsp;доработки.

Популярность open source проекта тоже повышает вероятность, что на&nbsp;вас обратят внимание. 
Указание на&nbsp;проблему в&nbsp;библиотеке с&nbsp;кучей звёздочек и пользователей повышает давление, её сложнее игнорировать. 
Получить такой результат без&nbsp;open source сложнее — твоё приложение должно быть суперпопулярным или тебя должны знать лично. 

### Пиар и личная мотивация

Последняя, но не по&nbsp;значимости, причина — это личная выгода. От&nbsp;публичности ежедневной работы выигрывают все. 
Компания привлекает внимание за&nbsp;счёт полезного продукта, а мы прокачиваем личный бренд как инженеры и получаем дополнительную мотивацию для&nbsp;работы. 
Больше не нужно выискивать по&nbsp;вечерам время на&nbsp;собственные проекты или коммиты в&nbsp;сторонние open source библиотеки.  

## Что вынесли в&nbsp;open source

Мы вынесли в&nbsp;репозиторий на&nbsp;Гитхабе почти всю нашу [инфраструктуру тестирования Android и CI/CD]({{< ref path="/docs/Infrastructure.md" lang="en" >}}). 
Чтобы другим разработчикам проще было сориентироваться в&nbsp;проекте, все модули сгруппированы по&nbsp;назначению:  

- Gradle плагины.
- Библиотеки для&nbsp;Android тестов.
- [Эмуляторы](https://github.com/avito-tech/avito-android/tree/develop/ci/docker)

Отмечу парочку наиболее значимых библиотек.

### Test runner

Это gradle плагин для&nbsp;запуска instrumentation тестов. 
Ближайший аналог — [Marathon](https://github.com/Malinskiy/marathon), но наш написан только под&nbsp;Android.

[Test Runner:]({{< ref path="/docs/test/Runner.md" lang="en" >}})

- Описывает, какие тесты запускать. Есть фильтрация по&nbsp;аннотациям, по&nbsp;пакетам, по&nbsp;результатам прошлого запуска.
- Описывает, на&nbsp;каких эмуляторах прогонять тесты. Резервирует их в&nbsp;Kubernetes или подключается к&nbsp;локальным эмуляторам.
- Задаёт условия перезапуска тестов.
- Отправляет итоговый отчет с&nbsp;результатами прогона тестов.

Результаты хранятся в&nbsp;кастомной TMS (test management system), её нет в&nbsp;open source. Мы работаем над&nbsp;тем, чтобы можно было подключить другую реализацию.

![](https://habrastorage.org/webt/1s/pt/62/1spt626ixunfqut3ya9ubxti_us.png)

### Impact analysis

У&nbsp;нас около 1600&nbsp;instrumentation тестов и 10K&nbsp;unit-тестов. Мы хотели бы запускать все тесты на&nbsp;любое изменение кода, но это невозможно — прогон займёт слишком много времени. 

Простое решение — вручную разделить тесты на&nbsp;разные наборы, например, smoke-тесты, быстрые, медленные, и запускать только часть. 
Но при&nbsp;таком подходе всегда есть шанс пропустить ошибку, потому что непонятно, какой набор тестов оптимальнее. 
Идеальное решение&nbsp;— понять, какой минимальный набор тестов проверит все изменения. 
Это называется [test impact analysis](https://martinfowler.com/articles/rise-test-impact-analysis.html).

Мы написали [Gradle plugin]({{< ref path="/docs/ci/ImpactAnalysis.md" lang="en" >}}), который ищет изменения в&nbsp;модулях, парсит тесты и определяет, какие из&nbsp;них запустить.

![](https://habrastorage.org/webt/ox/s3/8i/oxs38itwej7tehznhbslvjpmsi0.png)

Более подробно основные модули и подходы описаны в&nbsp;[документации проекта]({{< ref path="/docs/Infrastructure.md" lang="en" >}}). 
Сейчас она не очень хороша, да ещё и не вся переведена. Мы хотим сделать документацию понятнее, и нам нужна ваша помощь. 
Расскажите, что доработать и поправить в&nbsp;тексте [в&nbsp;нашем телеграм-чате](https://t-do.ru/avito_android_opensource). 

## Чем могут быть полезны наши библиотеки

Поскольку в&nbsp;проекте много составляющих, его использование зависит от&nbsp;ваших потребностей. 
Если вы решаете похожую задачу или просто хотите разобраться в&nbsp;технологии — смело пишите нам 
в&nbsp;телеграм-чат [на&nbsp;русском](https://t-do.ru/avito_android_opensource) или [на&nbsp;английском](https://t-do.ru/avito_android_opensource_en). 
Расскажем, что знаем, постараемся помочь и показать релевантные примеры.

Можно спрашивать что угодно:

- А как вы работаете с&nbsp;нестабильными тестами?
- Зачем так много кода? Он же бесполезный.
- Почему весь код в&nbsp;Gradle плагинах, а не в&nbsp;Python скриптах?

Если вы хотите использовать какой-то конкретный модуль, 
то можно попробовать его в&nbsp[тестовом приложении](https://github.com/avito-tech/avito-android/tree/develop/subprojects/android-test/test-app). 
Сейчас в&nbsp;нём показан пример использования test runner.

К&nbsp;сожалению, у&nbsp;нас пока мало примеров переиспользования в&nbsp;других проектах, поэтому при&nbsp;интеграции могут проявиться ещё неизвестные ограничения. 
Напишите нам, если такое произойдет, и мы посмотрим, что нужно доработать.

## Заключение

В&nbsp;следующих статьях мы планируем рассказать про: 

- Наш test runner.
- Анатомию теста — что происходит от&nbsp;нажатия кнопки “Run” в&nbsp;IDE до&nbsp;получения результата.
- Как мы боремся c&nbsp;нестабильностью тестов и инфраструктуры.
- Наши подходы к&nbsp;написанию инфраструктуры.
- Как мы сократили время релизов с&nbsp;месяца до&nbsp;недели. 

Есть идеи и по&nbsp;более общим темам:

- Как начать писать тесты.
- Основы тестирования для&nbsp;новичков — про&nbsp;общие подходы и технологии. 

Расскажите в&nbsp;комментариях, о&nbsp;чём вам будет интереснее узнать. Так мы поймём, какой текст писать в&nbsp;первую очередь.
